# 部署雲端規劃

## 伺服器資訊

| 項目 | 值 |
|------|---|
| 主機別名 | a96g |
| SSH 連線 | `ssh -p 2023 wa@home.nodered.vip` |
| Kubernetes Namespace | production |
| Deployment 名稱 | agri-kit-frontend |
| NFS 路徑 | `/mnt/a96g-nfs/agri-kit-frontend/` |

## NFS 目錄結構

```
/mnt/a96g-nfs/agri-kit-frontend/
├── nginx/                  # Nginx 配置
│   └── nginx.conf
├── public/                 # 網站靜態檔案 (部署目標)
└── public.YYYY.MMDD.bak/   # 備份目錄
```

## 部署步驟

### 1. 本地建置

```bash
npm run build
```

建置完成後會產生 `dist/` 目錄。

### 2. 備份雲端現有檔案

```bash
ssh -p 2023 wa@home.nodered.vip "cd /mnt/a96g-nfs/agri-kit-frontend && cp -r public public.$(date +%Y.%m%d).bak"
```

### 3. 上傳建置檔案

```bash
scp -P 2023 -r ./dist/* wa@home.nodered.vip:/mnt/a96g-nfs/agri-kit-frontend/public/
```

### 4. 驗證部署

```bash
# 檢查檔案是否上傳成功
ssh -p 2023 wa@home.nodered.vip "ls -la /mnt/a96g-nfs/agri-kit-frontend/public/"

# 檢查 Pod 狀態
ssh -p 2023 wa@home.nodered.vip "kubectl get pods -n production | grep agri-kit-frontend"
```

## 快速部署指令 (一鍵部署)

```bash
# 建置 + 備份 + 上傳
npm run build && \
ssh -p 2023 wa@home.nodered.vip "cd /mnt/a96g-nfs/agri-kit-frontend && cp -r public public.$(date +%Y.%m%d).bak" && \
scp -P 2023 -r ./dist/* wa@home.nodered.vip:/mnt/a96g-nfs/agri-kit-frontend/public/
```

## Kubernetes 配置更新 (如需要)

僅在修改 `agri-frontend.yaml` 時執行：

```bash
# 上傳配置檔
scp -P 2023 ./agri-frontend.yaml wa@home.nodered.vip:/home/wa/a96g/production/

# 套用配置
ssh -p 2023 wa@home.nodered.vip "kubectl apply -f /home/wa/a96g/production/agri-frontend.yaml"

# 檢查部署狀態
ssh -p 2023 wa@home.nodered.vip "kubectl rollout status deployment/agri-kit-frontend -n production"
```

## 回滾步驟

如需回滾到之前版本：

```bash
# 查看可用備份
ssh -p 2023 wa@home.nodered.vip "ls -la /mnt/a96g-nfs/agri-kit-frontend/ | grep public"

# 回滾 (以 2025.0120 為例)
ssh -p 2023 wa@home.nodered.vip "cd /mnt/a96g-nfs/agri-kit-frontend && rm -rf public && cp -r public.2025.0120.bak public"
```

## 連線別名設定

將以下內容加入 `~/.bashrc` 或 `~/.zshrc`：

```bash
alias a96g='ssh -p 2023 wa@home.nodered.vip'
alias a96g-mgr='ssh -p 2023 wa@home.nodered.vip'
alias a96g-nfs='ssh -p 2024 wa@home.nodered.vip'
```

設定後可直接使用 `a96g` 連線。
